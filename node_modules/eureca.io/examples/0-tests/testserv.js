var express = require('express')
  , app = express(app)
  , server = require('http').createServer(app);

  
  


// serve static files from the current directory
app.use(express.static(__dirname));




//we'll keep clients data here
var clients = {};
  
//get EurecaServer class
var EurecaServer = require('../../').EurecaServer;




//create an instance of EurecaServer
var eurecaServer = new EurecaServer({allow:['setId', 'spawnEnemy', 'kill', 'updateState']});



//attach eureca.io to our http server
eurecaServer.attach(server);



console.log(server.get);

function processPost(request, response, callback) {
	var queryData = "";
	if (typeof callback !== 'function') return null;

	if (request.method == 'POST') {
		request.on('data', function (data) {
			queryData += data;
			if (queryData.length > 1e6) {
				queryData = "";
				response.writeHead(413, { 'Content-Type': 'text/plain' }).end();
				request.connection.destroy();
			}
		});

		request.on('end', function () {
			request.post = qs.parse(queryData);
			callback();
		});

	} else {
		response.writeHead(405, { 'Content-Type': 'text/plain' });
		response.end();
	}
}


                      
server.on('request', function (request, response) {
	if (request.method === 'POST') {
		console.log('request url = ', request.url);
		if (request.url.split('?')[0] === '/webrtc-') {
			_this.processPost(request, response, function () {
				//console.log('Got post data', request.post);

				var offer = request.post[Protocol.signal];
				response.writeHead(200, "OK", { 'Content-Type': 'text/plain' });
				response.write('OK');
				response.end();

			});
		}
	}
});

//var app;
//if (server._events.request !== undefined && server.routes === undefined) app = server._events.request;



server.listen(8000);