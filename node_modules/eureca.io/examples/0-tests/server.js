var http = require('http');
var fs = require('fs');

var server = http.createServer();

var Eureca = require('../../');

var eurecaServer = new Eureca.Server({transport:'engine.io', allow:['add', 'echo']});

eurecaServer.attach(server);

eurecaServer.on('connect', function (socket) {
    var client = socket.clientProxy; //eurecaServer.getClient(socket.id);
    client.add(10, 20).onReady(function (r) { console.log('R=', r) });

    //setTimeout(function () {
    //    client.add(5000, 1000).onReady(function (r) { console.log('SR = ', r) });
    //}, 5000);
    //socket.send('raw data');
});

eurecaServer.on('message', function (data) {
    //console.log('received ', data);       
});

eurecaServer.exports.maths = {
    add : function(a, b) {
        return a + b;
    }

}


//functions under "exports" namespace will
//be exposed to client side
eurecaServer.exports.hello = function () {
    
    console.log('Hello from client');

    
    this.clientProxy.echo('ECHO FROM SERVER');
}

// Test zone =========================
/*
var qs = require('querystring');

function processPost(request, response, callback) {
    var queryData = "";
    if (typeof callback !== 'function') return null;

    if (request.method == 'POST') {
        request.on('data', function (data) {
            queryData += data;
            if (queryData.length > 1e6) {
                queryData = "";
                response.writeHead(413, { 'Content-Type': 'text/plain' }).end();
                request.connection.destroy();
            }
        });

        request.on('end', function () {
            request.post = qs.parse(queryData);
            callback();
        });

    } else {
        response.writeHead(405, { 'Content-Type': 'text/plain' });
        response.end();
    }
}
//var transport = Eureca.Transport.get('webrtc');
//transport.createServer(eurecaServer);

server.on('request', function (request, response) {
    var i;
    if (request.method === 'POST') {
        processPost(request, response, function () {
            console.log(request.post);
            // Use request.post here

            response.writeHead(200, "OK", { 'Content-Type': 'text/plain' });
            response.write("{'__signal__':'received'}");
            
            response.end();
        });



    }
});
*/
// Test zone =========================


server.on('request', function (request, response) {
    var i;
    
    if (request.method === 'GET') {
        
        if (request.url.split('?')[0] === '/') {
            var filename = __dirname + '/index.html';
            fs.readFile(filename, function (err, data) {
                var text = data.toString();
                response.writeHead(200, { 'Content-Type': 'text/html' });
                response.write(text);
                response.end();
            });
        }
    }

});

server.listen(8000);